# 概念

在内核中，PCI Express(PCIe)设备的管理框架由多个子系统组成，包括PCIe核心、设备驱动、层次性拓扑结构和电源管理等。

- PCIe核心：负责PCIe总线的探测、初始化、资源分配和设备驱动程序的注册等。在内核中，PCIe核心由PCI子系统和PCIe子系统组成。主要包括PCI子系统和PCIe子系统，以及一些共同的函数和数据结构，如pci_dev、pci_bus、pci_driver等。其中，pci_dev结构体表示一个PCI设备，pci_bus结构体表示一个PCI总线，pci_driver结构体表示一个PCI设备驱动程序。PCI子系统负责PCI总线的探测、资源分配和设备注册等，而PCIe子系统则负责PCIe总线的探测、初始化和设备注册等。
- 设备驱动程序：对不同类型的PCIe设备提供支持。设备驱动程序包括网络设备、存储设备、图形设备和多媒体设备等。主要包括网络设备驱动程序、存储设备驱动程序、图形设备驱动程序和多媒体设备驱动程序等。这些驱动程序使用pci_driver结构体注册到PCI子系统中，以实现对PCIe设备的支持。驱动程序中主要包括与硬件相关的函数和数据结构，以及与内核其他模块的交互函数。
- 层次性拓扑结构：表示与PCIe设备相关的拓扑结构。层次性拓扑结构由PCIe核心自动建立，它提供了PCIe设备的物理连通性和逻辑层次结构，有助于设备驱动程序的管理和维护。
- 电源管理：负责PCIe设备的电源管理，它可以使PCIe设备在不使用时降低功耗，从而延长电池寿命或节省电费。PCIe设备的电源管理由ACPI子系统提供支持。ACPI子系统中包括与硬件相关的函数和数据结构，以及与操作系统其他模块的交互函数。PCIe设备的电源管理可以包括设备的启动、挂起和恢复等。
- 中断处理：PCIe设备的中断处理通常由驱动程序负责。驱动程序使用pci_enable_msi()和pci_enable_msix()函数注册MSI或MSI-X中断，然后使用request_irq()函数注册中断处理函数，以响应设备产生的中断。中断处理函数通常负责处理中断，然后返回以结束中断处理。

总之，内核中的PCIe管理框架提供了一系列的子系统和工具，以帮助开发人员管理和优化PCIe设备的性能，并确保PCIe设备与内核之间的协议兼容性。

## 重要概念

BAR（Base Address Registers）和MMIO（Memory Mapped IO）是两个非常重要的概念。

BAR（Base Address Registers）：BAR是PCIe设备与主机之间通信的基础，它用于标识PCIe设备需要的资源，包括I/O端口和内存地址。每个设备可以拥有多个BAR，每个BAR可以对应一个I/O或内存资源。主机通过读取设备的BAR寄存器，可以获取该设备所占用的资源的起始地址和大小等信息。

MMIO（Memory Mapped IO）：MMIO是一种通过内存地址来访问I/O设备的机制。在PCIe设备中，MMIO用于访问设备的寄存器、配置空间和DMA缓冲区等，主机通过MMIO读写这些资源。MMIO访问与传统I/O端口访问不同，I/O端口访问是通过out/in指令进行的，而MMIO访问则是通过读写内存地址来完成的。

在PCIe设备中，MMIO通常是通过访问设备的BAR来实现的。设备的BAR中存储了一段物理内存地址，主机通过MMIO读写这个地址就可以访问设备的资源。当主机进行MMIO访问时，CPU会将访问请求路由到PCIe设备，设备进行相应的处理并返回结果。

## 初始化

PCI子系统初始化：PCI子系统的初始化是通过调用pci_init()函数完成的。这个函数主要是对PCI总线进行初始化，包括创建根总线、设置PCI驱动器程序、初始化PCI设备树等。

PCI驱动程序注册：当PCI子系统初始化完成后，PCI驱动程序开始进行注册。每个PCI驱动程序都是一个结构体，其中包含了所支持的设备ID、对应的设备的操作函数等信息。调用pci_register_driver()函数完成PCI驱动程序的注册。

PCI设备枚举：PCI设备枚举是PCI框架中非常重要的一个环节，它通过PCI总线上扫描每个设备的配置寄存器，以便确定设备的类型、功能、资源需求等信息。在这个过程中，PCI框架会调用PCI驱动程序的probe()函数，该函数会检测设备是否支持该驱动程序，并初始化设备（例如设备的I/O、内存、中断等资源）。

PCI设备树建立：在PCI设备枚举的过程中，PCI框架会根据设备的PCI地址（包括总线号、设备号、函数号）建立PCI设备树。每个设备节点包含了该设备的PCI地址、资源分配情况和驱动程序等信息。

PCI驱动程序初始化：当PCI设备枚举和设备树建立完成后，PCI框架会调用PCI驱动程序的初始化函数init()，该函数对设备进行进一步的初始化操作。例如，设备的中断注册、DMA设置等。

PCI设备注册：当PCI驱动程序初始化完成后，PCI框架会将该设备注册到系统中。注册完成后，系统就可以对设备进行正确的使用和管理。

PCI总线扫描结束：PCI总线扫描结束后，系统就可以正确地访问PCI设备和它们的资源了。此时，系统可以通过读写PCI设备的配置空间进行设备的操作，也可以应用系统提供的API来访问设备的资源。


## 数据结构

- struct pci_dev：这个结构体代表PCIe设备，其中包含这个设备的设备ID、厂商ID、类别码、子类别码、寻址信息、中断信息等。此外，这个结构体还包含一些函数指针，如probe和remove，用于设备的驱动注册和卸载。
- struct pci_driver：这个结构体代表PCIe设备的驱动，其中包含这个驱动支持的设备ID列表、驱动的名称、probe函数和remove函数等。当内核检测到一个PCIe设备时，会遍历所有已注册的驱动，找到匹配的驱动进行设备驱动的注册和初始化。
- struct pci_bus：这个结构体代表PCIe总线，其中包含了这个总线上所有设备的枚举信息和资源分配信息。
- struct pci_dev_resource：这个结构体代表PCIe设备的资源，如IO空间、内存空间、中断等。此外，这个结构体还包含一些函数指针，如request和release，用于资源的申请和释放。资源的起始地址和长度：pci_dev_resource结构中的start和end字段描述了该资源的物理地址范围。在x86架构中，这些地址通常是I/O地址或内存地址。length字段描述了该资源的长度。资源的描述符：res字段是指向该资源的描述符的指针。该描述符包含有关资源的详细信息，例如资源的类型、寻址模式和访问权限等。硬件资源类型：pci_dev_resource结构中的flags字段描述了该资源的类型，例如I/O端口、内存空间或中断线。
- struct pci_host_bridge：这个结构体代表PCIe主机桥，这是一个虚拟设备，用于管理整个PCIe总线。它包含一些与PCIe总线相关的信息和函数指针，如add_bus和remove_bus，用于扩展和移除PCIe总线上的设备。

